<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Housing.com AI Voice Agent</title>
    <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        padding: 20px; 
        max-width: 1200px; 
        margin: auto; 
        background: #f5f7fa;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .header h1 { color: #2c3e50; margin: 0; }
      .header p { color: #7f8c8d; margin: 10px 0 0 0; }
      
      .chat-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      #chat { 
        flex: 1;
        border: 1px solid #ddd; 
        height: 400px; 
        overflow: auto; 
        padding: 15px; 
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .requirements-panel {
        width: 300px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 400px;
        overflow: auto;
      }
      
      .requirements-panel h3 {
        color: #2c3e50;
        margin: 0 0 15px 0;
        font-size: 16px;
      }
      
      .requirement-item {
        margin: 8px 0;
        padding: 8px;
        background: #ecf0f1;
        border-radius: 5px;
        font-size: 14px;
      }
      
      .requirement-label {
        font-weight: bold;
        color: #34495e;
      }
      
      .msg { 
        margin: 15px 0; 
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
      }
      .user { 
        background: #e3f2fd;
        margin-left: auto;
        text-align: right;
      }
      .bot { 
        background: #f1f8e9;
        margin-right: auto;
      }
      
      .cards { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        margin-top: 20px; 
      }
      
      .card { 
        border: 1px solid #ddd; 
        padding: 15px; 
        width: 350px; 
        border-radius: 10px; 
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      
      .card h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 16px;
      }
      
      .card p {
        color: #7f8c8d;
        font-size: 14px;
        margin: 5px 0;
      }
      
      .card-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      
      .controls {
        text-align: center;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      button { 
        padding: 12px 20px; 
        margin: 0 10px; 
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
      }
      
      #startBtn {
        background: #27ae60;
        color: white;
      }
      
      #startBtn:hover {
        background: #219a52;
      }
      
      #stopBtn {
        background: #e74c3c;
        color: white;
      }
      
      #stopBtn:hover {
        background: #c0392b;
      }
      
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }
      
      .feedback-btn {
        padding: 8px 15px;
        font-size: 14px;
        border-radius: 5px;
      }
      
      .like-btn {
        background: #27ae60;
        color: white;
      }
      
      .dislike-btn {
        background: #e74c3c;
        color: white;
      }
      
      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      
      .status.listening {
        background: #d4edda;
        color: #155724;
      }
      
      .status.processing {
        background: #fff3cd;
        color: #856404;
      }
      
      .conversation-state {
        background: #e7f3ff;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 12px;
        color: #0056b3;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üè† Housing.com AI Voice Agent</h1>
      <p>Your personal property consultant - speak naturally to find your dream home</p>
    </div>

    <div class="chat-container">
      <div id="chat"></div>
      <div class="requirements-panel">
        <h3>üìã Your Requirements</h3>
        <div id="requirements"></div>
        <div class="conversation-state" id="conversationState">Getting ready...</div>
      </div>
    </div>

    <div class="cards" id="cards"></div>
    
    <div class="controls">
      <div id="status" class="status" style="display: none;"></div>
      <button id="startBtn">üé§ Start Conversation</button>
      <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      <button id="clearBtn">üóëÔ∏è New Session</button>
    </div>

    <script>
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const clearBtn = document.getElementById('clearBtn');
      const chat = document.getElementById('chat');
      const cards = document.getElementById('cards');
      const requirements = document.getElementById('requirements');
      const conversationState = document.getElementById('conversationState');
      const status = document.getElementById('status');
      const backendUrl = (window.location.hostname === 'localhost') ? 'http://localhost:3001' : '';

      let recognition;
      let sessionId = 'demo-session-' + Date.now();
      let isFirstMessage = true;

      function showStatus(message, type = '') {
        status.textContent = message;
        status.className = 'status ' + type;
        status.style.display = 'block';
      }

      function hideStatus() {
        status.style.display = 'none';
      }

      function appendMessage(who, text) {
        const el = document.createElement('div');
        el.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
        el.innerHTML = `<strong>${who === 'user' ? 'You' : 'Sarah'}:</strong> ${text}`;
        chat.appendChild(el);
        chat.scrollTop = chat.scrollHeight;
      }

      function updateRequirements(reqs) {
        requirements.innerHTML = '';
        if (Object.keys(reqs).length === 0) {
          requirements.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Tell me your requirements...</p>';
          return;
        }

        const reqMap = {
          propertyType: { label: 'Property Type', icon: 'üè°' },
          budget: { label: 'Budget', icon: 'üí∞' },
          city: { label: 'City', icon: 'üìç' },
          locality: { label: 'Locality', icon: 'üåÜ' },
          bhk: { label: 'BHK', icon: 'üõèÔ∏è' }
        };

        for (const [key, value] of Object.entries(reqs)) {
          if (key === 'conversationStarted') continue;
          const config = reqMap[key] || { label: key, icon: 'üìù' };
          const el = document.createElement('div');
          el.className = 'requirement-item';
          el.innerHTML = `<span class="requirement-label">${config.icon} ${config.label}:</span> ${value}`;
          requirements.appendChild(el);
        }
      }

      function updateConversationState(state) {
        const stateMap = {
          introduction: 'Getting to know you',
          gathering_requirements: 'Understanding your needs',
          searching: 'Searching properties',
          presenting_results: 'Showing results',
          collecting_feedback: 'Getting your feedback'
        };
        conversationState.textContent = stateMap[state] || state;
      }

      function showCards(links) {
        cards.innerHTML = '';
        if (!links || links.length === 0) return;

        links.forEach((l, index) => {
          const c = document.createElement('div');
          c.className = 'card';
          c.innerHTML = `
            <h4>${l.title || 'Property Listing'}</h4>
            <p>${l.snippet || 'No description available'}</p>
            <a href="${l.link}" target="_blank">View on Housing.com ‚Üí</a>
            <div class="card-actions">
              <button class="feedback-btn like-btn" onclick="sendFeedback('${l.link}', 'like')">üëç Interested</button>
              <button class="feedback-btn dislike-btn" onclick="sendFeedback('${l.link}', 'dislike')">üëé Not for me</button>
            </div>
          `;
          cards.appendChild(c);
        });
      }

      async function sendFeedback(propertyId, feedback) {
        const reason = feedback === 'dislike' ? 
          prompt('What didn\'t you like about this property? (This helps me find better matches)') : 
          prompt('What did you like about this property? (Optional)');

        try {
          showStatus('Processing your feedback...', 'processing');
          const resp = await fetch(backendUrl + '/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, propertyId, feedback, reason })
          });
          const data = await resp.json();
          
          appendMessage('bot', data.replyText);
          if (data.links && data.links.length > 0) {
            showCards(data.links);
          }
          
          if (data.audio && data.audio.type === 'ssml_fallback') {
            const utter = new SpeechSynthesisUtterance(data.audio.text);
            speechSynthesis.speak(utter);
          }
          hideStatus();
        } catch (err) {
          appendMessage('bot', 'Error processing feedback: ' + err.message);
          hideStatus();
        }
      }

      async function sendTextToBackend(text) {
        appendMessage('user', text);
        showStatus('Thinking...', 'processing');
        
        try {
          const resp = await fetch(backendUrl + '/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, text })
          });
          const data = await resp.json();
          
          appendMessage('bot', data.replyText || 'I understand.');
          
          if (data.requirements) {
            updateRequirements(data.requirements);
          }
          
          if (data.conversationState) {
            updateConversationState(data.conversationState);
          }
          
          if (data.links && data.links.length > 0) {
            showCards(data.links);
          }
          
          // Handle audio
          if (data.audio && data.audio.type === 'ssml_fallback') {
            const utter = new SpeechSynthesisUtterance(data.audio.text);
            speechSynthesis.speak(utter);
          } else if (data.audio && data.audio.url) {
            const audio = new Audio(data.audio.url);
            audio.play();
          }
          
          hideStatus();
        } catch (err) {
          appendMessage('bot', 'Error: ' + (err.message || err));
          hideStatus();
        }
      }

      // Initialize the conversation
      async function initializeConversation() {
        if (isFirstMessage) {
          isFirstMessage = false;
          await sendTextToBackend('Hello');
        }
      }

      startBtn.onclick = () => {
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
          alert('Your browser does not support Web Speech API. Please use Chrome.');
          return;
        }
        
        recognition = new window.SpeechRecognition();
        recognition.lang = 'en-IN';
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onstart = () => {
          startBtn.disabled = true;
          stopBtn.disabled = false;
          showStatus('üé§ Listening... Speak now', 'listening');
        };
        
        recognition.onresult = (e) => {
          const text = e.results[0][0].transcript;
          hideStatus();
          sendTextToBackend(text);
        };
        
        recognition.onerror = (e) => {
          console.error('Speech error', e);
          startBtn.disabled = false;
          stopBtn.disabled = true;
          hideStatus();
          if (e.error === 'no-speech') {
            showStatus('No speech detected. Please try again.', 'processing');
            setTimeout(hideStatus, 3000);
          }
        };
        
        recognition.onend = () => {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          hideStatus();
        };
        
        recognition.start();
        
        // Initialize conversation if this is the first interaction
        if (isFirstMessage) {
          setTimeout(initializeConversation, 1000);
        }
      };

      stopBtn.onclick = () => {
        if (recognition) recognition.stop();
      };

      clearBtn.onclick = async () => {
        if (confirm('Start a new conversation? This will clear your current session.')) {
          // Clear session on backend
          try {
            await fetch(backendUrl + '/session/' + sessionId, { method: 'DELETE' });
          } catch (err) {
            console.error('Error clearing session:', err);
          }
          
          // Reset frontend
          sessionId = 'demo-session-' + Date.now();
          isFirstMessage = true;
          chat.innerHTML = '';
          cards.innerHTML = '';
          requirements.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Tell me your requirements...</p>';
          conversationState.textContent = 'Getting ready...';
          hideStatus();
        }
      };

      // Make sendFeedback globally available
      window.sendFeedback = sendFeedback;

      // Initialize requirements display
      updateRequirements({});
    </script>
  </body>
</html>
